<template>
	<view class="container">
		<!-- 顶部进度 -->
		<view class="progress-bar">
			<view class="progress" :style="{ width: `${(currentStep / totalSteps) * 100}%` }"></view>
			<text class="progress-text">第 {{ currentStep }}/{{ totalSteps }} 步</text>
		</view>

		<!-- 问卷内容 -->
		<scroll-view class="question-container" scroll-y="true">
			<view class="question-section" v-if="currentStep === 1">
				<view class="section-title">
					<text class="title-icon">👤</text>
					基础信息
				</view>
				<view class="form-item">
					<text class="label">年龄</text>
					<input type="number" v-model="basicInfo.age" class="input" placeholder="请输入年龄" />
				</view>
				<view class="form-item">
					<text class="label">性别</text>
					<radio-group class="radio-group" @change="onGenderChange">
						<label class="radio-label">
							<radio value="male" :checked="basicInfo.gender === 'male'" />
							<text>男</text>
						</label>
						<label class="radio-label">
							<radio value="female" :checked="basicInfo.gender === 'female'" />
							<text>女</text>
						</label>
					</radio-group>
				</view>
				<view class="form-item">
					<text class="label">身高(cm)</text>
					<input type="number" v-model="basicInfo.height" class="input" placeholder="请输入身高" />
				</view>
				<view class="form-item">
					<text class="label">体重(kg)</text>
					<input type="number" v-model="basicInfo.weight" class="input" placeholder="请输入体重" />
				</view>
			</view>

			<view class="question-section" v-if="currentStep === 2">
				<view class="section-title">
					<text class="title-icon">🌱</text>
					生活习惯
				</view>
				<view class="question-item" v-for="(question, index) in lifestyleQuestions" :key="index">
					<text class="question-text">{{ question.text }}</text>
					<radio-group class="radio-group" @change="(e) => onLifestyleChange(index, e)">
						<label class="radio-label" v-for="(option, optIndex) in question.options" :key="optIndex">
							<radio :value="String(optIndex)" :checked="question.answer === optIndex" />
							<text>{{ option }}</text>
						</label>
					</radio-group>
				</view>
			</view>

			<view class="question-section" v-if="currentStep === 3">
				<view class="section-title">
					<text class="title-icon">🧠</text>
					心理健康
				</view>
				<view class="question-item" v-for="(question, index) in mentalHealthQuestions" :key="index">
					<text class="question-text">{{ question.text }}</text>
					<radio-group class="radio-group" @change="(e) => onMentalHealthChange(index, e)">
						<label class="radio-label" v-for="(option, optIndex) in question.options" :key="optIndex">
							<radio :value="String(optIndex)" :checked="question.answer === optIndex" />
							<text>{{ option }}</text>
						</label>
					</radio-group>
				</view>
			</view>

			<view class="question-section" v-if="currentStep === 4">
				<view class="section-title">
					<text class="title-icon">📊</text>
					评估结果
				</view>
				<view class="result-card">
					<view class="result-item">
						<text class="result-label">BMI指数</text>
						<text class="result-value">{{ calculateBMI() }}</text>
					</view>
					<view class="result-item">
						<text class="result-label">生活习惯评分</text>
						<text class="result-value">{{ calculateLifestyleScore() }}</text>
					</view>
					<view class="result-item">
						<text class="result-label">心理健康评分</text>
						<text class="result-value">{{ calculateMentalHealthScore() }}</text>
					</view>
					<view class="suggestion-box">
						<text class="suggestion-title">健康建议</text>
						<text class="suggestion-text">{{ generateSuggestion() }}</text>
					</view>
				</view>
			</view>
		</scroll-view>

		<!-- 底部按钮 -->
		<view class="bottom-buttons">
			<button class="btn prev-btn" v-if="currentStep > 1" @click="prevStep">上一步</button>
			<button class="btn next-btn" v-if="currentStep < totalSteps" @click="nextStep">下一步</button>
			<button class="btn submit-btn" v-if="currentStep === totalSteps" @click="submitTest">提交评估</button>
		</view>
	</view>
</template>

<script setup lang="uts">
import { ref, computed } from 'vue'

// 基础信息
const basicInfo = ref({
	age: '',
	gender: '',
	height: '',
	weight: ''
})

// 生活习惯问题
const lifestyleQuestions = ref([
	{
		text: '您每天的睡眠时间是多少？',
		options: ['少于6小时', '6-8小时', '8-10小时', '超过10小时'],
		answer: -1
	},
	{
		text: '您每周运动频率如何？',
		options: ['从不运动', '1-2次', '3-4次', '5次以上'],
		answer: -1
	},
	{
		text: '您的饮食习惯如何？',
		options: ['不规律', '基本规律', '非常规律', '严格规律'],
		answer: -1
	},
	{
		text: '您每天的饮水量是多少？',
		options: ['少于1L', '1-2L', '2-3L', '超过3L'],
		answer: -1
	},
	{
		text: '您是否有吸烟或饮酒习惯？',
		options: ['经常', '偶尔', '很少', '从不'],
		answer: -1
	}
])

// 心理健康问题
const mentalHealthQuestions = ref([
	{
		text: '您最近的情绪状态如何？',
		options: ['经常焦虑', '偶尔焦虑', '基本稳定', '非常愉悦'],
		answer: -1
	},
	{
		text: '您的工作压力如何？',
		options: ['压力很大', '压力较大', '压力适中', '压力较小'],
		answer: -1
	},
	{
		text: '您的人际关系如何？',
		options: ['关系紧张', '关系一般', '关系良好', '关系融洽'],
		answer: -1
	},
	{
		text: '您对生活充满希望吗？',
		options: ['很少', '一般', '比较乐观', '非常乐观'],
		answer: -1
	},
	{
		text: '您是否经常感到疲惫？',
		options: ['经常', '偶尔', '很少', '从不'],
		answer: -1
	}
])

// 步骤控制
const currentStep = ref(1)
const totalSteps = 4

// 重置所有数据
const resetAllData = () => {
	basicInfo.value = {
		age: '',
		gender: '',
		height: '',
		weight: ''
	}
	
	lifestyleQuestions.value.forEach(q => q.answer = -1)
	mentalHealthQuestions.value.forEach(q => q.answer = -1)
	currentStep.value = 1
}

// 性别选择
const onGenderChange = (e: any) => {
	basicInfo.value.gender = e.detail.value
}

// 生活习惯选择
const onLifestyleChange = (index: number, e: any) => {
	lifestyleQuestions.value[index].answer = Number(e.detail.value)
}

// 心理健康选择
const onMentalHealthChange = (index: number, e: any) => {
	mentalHealthQuestions.value[index].answer = Number(e.detail.value)
}

// 步骤切换
const prevStep = () => {
	if (currentStep.value > 1) {
		currentStep.value--
	}
}

const nextStep = () => {
	if (currentStep.value < totalSteps) {
		currentStep.value++
	}
}

// 计算BMI
const calculateBMI = () => {
	if (!basicInfo.value.height || !basicInfo.value.weight) return '--'
	const height = Number(basicInfo.value.height) / 100
	const weight = Number(basicInfo.value.weight)
	const bmi = weight / (height * height)
	return bmi.toFixed(1)
}

// 计算生活习惯评分
const calculateLifestyleScore = () => {
	const total = lifestyleQuestions.value.reduce((sum, q) => sum + (q.answer >= 0 ? q.answer : 0), 0)
	return Math.round((total / (lifestyleQuestions.value.length * 3)) * 100)
}

// 计算心理健康评分
const calculateMentalHealthScore = () => {
	const total = mentalHealthQuestions.value.reduce((sum, q) => sum + (q.answer >= 0 ? q.answer : 0), 0)
	return Math.round((total / (mentalHealthQuestions.value.length * 3)) * 100)
}

// 生成健康建议
const generateSuggestion = () => {
	const bmi = Number(calculateBMI())
	const lifestyleScore = calculateLifestyleScore()
	const mentalHealthScore = calculateMentalHealthScore()
	
	let suggestions = []
	
	// BMI相关建议
	if (bmi < 18.5) {
		suggestions.push('您的体重偏轻，建议：\n1. 适当增加优质蛋白的摄入，如瘦肉、鱼类、蛋类\n2. 注意营养均衡，多吃新鲜蔬菜水果\n3. 进行力量训练，增加肌肉量\n4. 保持规律作息，确保充足睡眠')
	} else if (bmi > 24) {
		suggestions.push('您的体重偏重，建议：\n1. 控制每日热量摄入，建议减少300-500卡路里\n2. 增加运动量，每周进行3-5次有氧运动\n3. 避免高糖、高脂食物，选择低热量、高纤维的食物\n4. 保持规律作息，避免熬夜')
	}
	
	// 生活习惯建议
	if (lifestyleScore < 60) {
		suggestions.push('您的生活习惯需要改善，建议：\n1. 保持规律作息，每天保证7-8小时睡眠\n2. 每周进行3-4次中等强度运动，每次30-60分钟\n3. 保持均衡饮食，每天摄入充足的水分\n4. 避免久坐，每隔1小时起身活动5-10分钟\n5. 戒烟限酒，保持健康的生活方式')
	} else if (lifestyleScore >= 80) {
		suggestions.push('您的生活习惯良好，建议：\n1. 继续保持当前的作息规律\n2. 可以尝试增加一些新的运动项目，保持运动兴趣\n3. 定期进行健康体检，预防疾病\n4. 与家人朋友分享健康经验，带动他人')
	}
	
	// 心理健康建议
	if (mentalHealthScore < 60) {
		suggestions.push('您的心理状态需要关注，建议：\n1. 每天进行15-20分钟的冥想或深呼吸练习\n2. 保持社交活动，与家人朋友多交流\n3. 培养兴趣爱好，转移注意力\n4. 适当运动，释放压力\n5. 如果压力持续，建议寻求专业心理咨询')
	} else if (mentalHealthScore >= 80) {
		suggestions.push('您的心理状态良好，建议：\n1. 继续保持积极乐观的心态\n2. 可以尝试帮助他人，传递正能量\n3. 定期进行自我反思和总结\n4. 保持工作与生活的平衡')
	}
	
	// 综合建议
	if (suggestions.length === 0) {
		suggestions.push('您的健康状况良好，建议：\n1. 继续保持当前的生活方式\n2. 定期进行健康检查\n3. 保持运动习惯，增强体质\n4. 关注营养均衡，预防疾病\n5. 保持积极乐观的心态')
	}
	
	// 添加通用建议
	suggestions.push('\n温馨提示：\n1. 建议每年进行一次全面体检\n2. 保持规律的作息时间\n3. 注意饮食卫生，避免暴饮暴食\n4. 保持适度运动，避免过度运动\n5. 如有不适及时就医')
	
	return suggestions.join('\n\n')
}

// 提交评估
const submitTest = () => {
	uni.showLoading({
		title: '提交中...'
	})
	
	setTimeout(() => {
		uni.hideLoading()
		uni.showToast({
			title: '评估完成',
			icon: 'success',
			duration: 2000
		})
		
		// 延迟2秒后重置数据
		setTimeout(() => {
			resetAllData()
		}, 2000)
	}, 1500)
}
</script>

<style>
.container {
	min-height: 100vh;
	background-color: #F5F9FF;
	display: flex;
	flex-direction: column;
}

.progress-bar {
	height: 8rpx;
	background-color: #E8F0FE;
	position: relative;
	margin-bottom: 20rpx;
}

.progress {
	height: 100%;
	background: linear-gradient(90deg, #4A90E2, #6BA4E5);
	transition: width 0.3s ease;
	border-radius: 4rpx;
}

.progress-text {
	position: absolute;
	right: 30rpx;
	top: -30rpx;
	font-size: 24rpx;
	color: #666;
}

.question-container {
	flex: 1;
	padding: 30rpx;
}

.question-section {
	background-color: #fff;
	border-radius: 24rpx;
	padding: 40rpx;
	margin-bottom: 30rpx;
	box-shadow: 0 8rpx 24rpx rgba(74, 144, 226, 0.08);
}

.section-title {
	font-size: 36rpx;
	font-weight: bold;
	color: #333;
	margin-bottom: 40rpx;
	display: flex;
	align-items: center;
}

.title-icon {
	margin-right: 16rpx;
	font-size: 40rpx;
}

.form-item {
	margin-bottom: 40rpx;
}

.label {
	font-size: 30rpx;
	color: #333;
	margin-bottom: 16rpx;
	display: block;
	font-weight: 500;
}

.input {
	width: 100%;
	height: 88rpx;
	background-color: #F8FAFF;
	border-radius: 16rpx;
	padding: 0 24rpx;
	font-size: 30rpx;
	border: 2rpx solid #E8F0FE;
}

.radio-group {
	display: flex;
	flex-wrap: wrap;
	gap: 24rpx;
}

.radio-label {
	display: flex;
	align-items: center;
	font-size: 30rpx;
	color: #333;
	padding: 16rpx 32rpx;
	background-color: #F8FAFF;
	border-radius: 12rpx;
	border: 2rpx solid #E8F0FE;
}

.question-item {
	margin-bottom: 50rpx;
}

.question-text {
	font-size: 30rpx;
	color: #333;
	margin-bottom: 24rpx;
	display: block;
	font-weight: 500;
}

.result-card {
	background-color: #F8FAFF;
	border-radius: 20rpx;
	padding: 40rpx;
}

.result-item {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 30rpx;
	padding: 20rpx;
	background-color: #fff;
	border-radius: 16rpx;
	box-shadow: 0 4rpx 12rpx rgba(74, 144, 226, 0.06);
}

.result-label {
	font-size: 30rpx;
	color: #333;
}

.result-value {
	font-size: 36rpx;
	color: #4A90E2;
	font-weight: bold;
}

.suggestion-box {
	margin-top: 40rpx;
	padding-top: 30rpx;
	border-top: 2rpx solid #E8F0FE;
}

.suggestion-title {
	font-size: 32rpx;
	color: #333;
	font-weight: bold;
	margin-bottom: 16rpx;
	display: block;
}

.suggestion-text {
	font-size: 28rpx;
	color: #666;
	line-height: 1.8;
}

.bottom-buttons {
	padding: 30rpx;
	display: flex;
	gap: 24rpx;
	background-color: #fff;
	box-shadow: 0 -4rpx 16rpx rgba(0, 0, 0, 0.06);
}

.btn {
	flex: 1;
	height: 88rpx;
	border-radius: 44rpx;
	font-size: 32rpx;
	display: flex;
	align-items: center;
	justify-content: center;
	font-weight: 500;
	transition: all 0.3s ease;
}

.prev-btn {
	background-color: #F8FAFF;
	color: #666;
}

.prev-btn:active {
	background-color: #E8F0FE;
}

.next-btn, .submit-btn {
	background: linear-gradient(90deg, #4A90E2, #6BA4E5);
	color: #fff;
}

.next-btn:active, .submit-btn:active {
	transform: scale(0.98);
	opacity: 0.9;
}
</style> 