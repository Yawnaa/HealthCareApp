<template>
	<view class="container">
		<!-- é¡¶éƒ¨è¿›åº¦ -->
		<view class="progress-bar">
			<view class="progress" :style="{ width: `${(currentStep / totalSteps) * 100}%` }"></view>
			<text class="progress-text">ç¬¬ {{ currentStep }}/{{ totalSteps }} æ­¥</text>
		</view>

		<!-- é—®å·å†…å®¹ -->
		<scroll-view class="question-container" scroll-y="true">
			<view class="question-section" v-if="currentStep === 1">
				<view class="section-title">
					<text class="title-icon">ğŸ‘¤</text>
					åŸºç¡€ä¿¡æ¯
				</view>
				<view class="form-item">
					<text class="label">å¹´é¾„</text>
					<input type="number" v-model="basicInfo.age" class="input" placeholder="è¯·è¾“å…¥å¹´é¾„" />
				</view>
				<view class="form-item">
					<text class="label">æ€§åˆ«</text>
					<radio-group class="radio-group" @change="onGenderChange">
						<label class="radio-label">
							<radio value="male" :checked="basicInfo.gender === 'male'" />
							<text>ç”·</text>
						</label>
						<label class="radio-label">
							<radio value="female" :checked="basicInfo.gender === 'female'" />
							<text>å¥³</text>
						</label>
					</radio-group>
				</view>
				<view class="form-item">
					<text class="label">èº«é«˜(cm)</text>
					<input type="number" v-model="basicInfo.height" class="input" placeholder="è¯·è¾“å…¥èº«é«˜" />
				</view>
				<view class="form-item">
					<text class="label">ä½“é‡(kg)</text>
					<input type="number" v-model="basicInfo.weight" class="input" placeholder="è¯·è¾“å…¥ä½“é‡" />
				</view>
			</view>

			<view class="question-section" v-if="currentStep === 2">
				<view class="section-title">
					<text class="title-icon">ğŸŒ±</text>
					ç”Ÿæ´»ä¹ æƒ¯
				</view>
				<view class="question-item" v-for="(question, index) in lifestyleQuestions" :key="index">
					<text class="question-text">{{ question.text }}</text>
					<radio-group class="radio-group" @change="(e) => onLifestyleChange(index, e)">
						<label class="radio-label" v-for="(option, optIndex) in question.options" :key="optIndex">
							<radio :value="String(optIndex)" :checked="question.answer === optIndex" />
							<text>{{ option }}</text>
						</label>
					</radio-group>
				</view>
			</view>

			<view class="question-section" v-if="currentStep === 3">
				<view class="section-title">
					<text class="title-icon">ğŸ§ </text>
					å¿ƒç†å¥åº·
				</view>
				<view class="question-item" v-for="(question, index) in mentalHealthQuestions" :key="index">
					<text class="question-text">{{ question.text }}</text>
					<radio-group class="radio-group" @change="(e) => onMentalHealthChange(index, e)">
						<label class="radio-label" v-for="(option, optIndex) in question.options" :key="optIndex">
							<radio :value="String(optIndex)" :checked="question.answer === optIndex" />
							<text>{{ option }}</text>
						</label>
					</radio-group>
				</view>
			</view>

			<view class="question-section" v-if="currentStep === 4">
				<view class="section-title">
					<text class="title-icon">ğŸ“Š</text>
					è¯„ä¼°ç»“æœ
				</view>
				<view class="result-card">
					<view class="result-item">
						<text class="result-label">BMIæŒ‡æ•°</text>
						<text class="result-value">{{ calculateBMI() }}</text>
					</view>
					<view class="result-item">
						<text class="result-label">ç”Ÿæ´»ä¹ æƒ¯è¯„åˆ†</text>
						<text class="result-value">{{ calculateLifestyleScore() }}</text>
					</view>
					<view class="result-item">
						<text class="result-label">å¿ƒç†å¥åº·è¯„åˆ†</text>
						<text class="result-value">{{ calculateMentalHealthScore() }}</text>
					</view>
					<view class="suggestion-box">
						<text class="suggestion-title">å¥åº·å»ºè®®</text>
						<text class="suggestion-text">{{ generateSuggestion() }}</text>
					</view>
				</view>
			</view>
		</scroll-view>

		<!-- åº•éƒ¨æŒ‰é’® -->
		<view class="bottom-buttons">
			<button class="btn prev-btn" v-if="currentStep > 1" @click="prevStep">ä¸Šä¸€æ­¥</button>
			<button class="btn next-btn" v-if="currentStep < totalSteps" @click="nextStep">ä¸‹ä¸€æ­¥</button>
			<button class="btn submit-btn" v-if="currentStep === totalSteps" @click="submitTest">æäº¤è¯„ä¼°</button>
		</view>
	</view>
</template>

<script setup lang="uts">
import { ref, computed } from 'vue'

// åŸºç¡€ä¿¡æ¯
const basicInfo = ref({
	age: '',
	gender: '',
	height: '',
	weight: ''
})

// ç”Ÿæ´»ä¹ æƒ¯é—®é¢˜
const lifestyleQuestions = ref([
	{
		text: 'æ‚¨æ¯å¤©çš„ç¡çœ æ—¶é—´æ˜¯å¤šå°‘ï¼Ÿ',
		options: ['å°‘äº6å°æ—¶', '6-8å°æ—¶', '8-10å°æ—¶', 'è¶…è¿‡10å°æ—¶'],
		answer: -1
	},
	{
		text: 'æ‚¨æ¯å‘¨è¿åŠ¨é¢‘ç‡å¦‚ä½•ï¼Ÿ',
		options: ['ä»ä¸è¿åŠ¨', '1-2æ¬¡', '3-4æ¬¡', '5æ¬¡ä»¥ä¸Š'],
		answer: -1
	},
	{
		text: 'æ‚¨çš„é¥®é£Ÿä¹ æƒ¯å¦‚ä½•ï¼Ÿ',
		options: ['ä¸è§„å¾‹', 'åŸºæœ¬è§„å¾‹', 'éå¸¸è§„å¾‹', 'ä¸¥æ ¼è§„å¾‹'],
		answer: -1
	},
	{
		text: 'æ‚¨æ¯å¤©çš„é¥®æ°´é‡æ˜¯å¤šå°‘ï¼Ÿ',
		options: ['å°‘äº1L', '1-2L', '2-3L', 'è¶…è¿‡3L'],
		answer: -1
	},
	{
		text: 'æ‚¨æ˜¯å¦æœ‰å¸çƒŸæˆ–é¥®é…’ä¹ æƒ¯ï¼Ÿ',
		options: ['ç»å¸¸', 'å¶å°”', 'å¾ˆå°‘', 'ä»ä¸'],
		answer: -1
	}
])

// å¿ƒç†å¥åº·é—®é¢˜
const mentalHealthQuestions = ref([
	{
		text: 'æ‚¨æœ€è¿‘çš„æƒ…ç»ªçŠ¶æ€å¦‚ä½•ï¼Ÿ',
		options: ['ç»å¸¸ç„¦è™‘', 'å¶å°”ç„¦è™‘', 'åŸºæœ¬ç¨³å®š', 'éå¸¸æ„‰æ‚¦'],
		answer: -1
	},
	{
		text: 'æ‚¨çš„å·¥ä½œå‹åŠ›å¦‚ä½•ï¼Ÿ',
		options: ['å‹åŠ›å¾ˆå¤§', 'å‹åŠ›è¾ƒå¤§', 'å‹åŠ›é€‚ä¸­', 'å‹åŠ›è¾ƒå°'],
		answer: -1
	},
	{
		text: 'æ‚¨çš„äººé™…å…³ç³»å¦‚ä½•ï¼Ÿ',
		options: ['å…³ç³»ç´§å¼ ', 'å…³ç³»ä¸€èˆ¬', 'å…³ç³»è‰¯å¥½', 'å…³ç³»èæ´½'],
		answer: -1
	},
	{
		text: 'æ‚¨å¯¹ç”Ÿæ´»å……æ»¡å¸Œæœ›å—ï¼Ÿ',
		options: ['å¾ˆå°‘', 'ä¸€èˆ¬', 'æ¯”è¾ƒä¹è§‚', 'éå¸¸ä¹è§‚'],
		answer: -1
	},
	{
		text: 'æ‚¨æ˜¯å¦ç»å¸¸æ„Ÿåˆ°ç–²æƒ«ï¼Ÿ',
		options: ['ç»å¸¸', 'å¶å°”', 'å¾ˆå°‘', 'ä»ä¸'],
		answer: -1
	}
])

// æ­¥éª¤æ§åˆ¶
const currentStep = ref(1)
const totalSteps = 4

// é‡ç½®æ‰€æœ‰æ•°æ®
const resetAllData = () => {
	basicInfo.value = {
		age: '',
		gender: '',
		height: '',
		weight: ''
	}
	
	lifestyleQuestions.value.forEach(q => q.answer = -1)
	mentalHealthQuestions.value.forEach(q => q.answer = -1)
	currentStep.value = 1
}

// æ€§åˆ«é€‰æ‹©
const onGenderChange = (e: any) => {
	basicInfo.value.gender = e.detail.value
}

// ç”Ÿæ´»ä¹ æƒ¯é€‰æ‹©
const onLifestyleChange = (index: number, e: any) => {
	lifestyleQuestions.value[index].answer = Number(e.detail.value)
}

// å¿ƒç†å¥åº·é€‰æ‹©
const onMentalHealthChange = (index: number, e: any) => {
	mentalHealthQuestions.value[index].answer = Number(e.detail.value)
}

// æ­¥éª¤åˆ‡æ¢
const prevStep = () => {
	if (currentStep.value > 1) {
		currentStep.value--
	}
}

const nextStep = () => {
	if (currentStep.value < totalSteps) {
		currentStep.value++
	}
}

// è®¡ç®—BMI
const calculateBMI = () => {
	if (!basicInfo.value.height || !basicInfo.value.weight) return '--'
	const height = Number(basicInfo.value.height) / 100
	const weight = Number(basicInfo.value.weight)
	const bmi = weight / (height * height)
	return bmi.toFixed(1)
}

// è®¡ç®—ç”Ÿæ´»ä¹ æƒ¯è¯„åˆ†
const calculateLifestyleScore = () => {
	const total = lifestyleQuestions.value.reduce((sum, q) => sum + (q.answer >= 0 ? q.answer : 0), 0)
	return Math.round((total / (lifestyleQuestions.value.length * 3)) * 100)
}

// è®¡ç®—å¿ƒç†å¥åº·è¯„åˆ†
const calculateMentalHealthScore = () => {
	const total = mentalHealthQuestions.value.reduce((sum, q) => sum + (q.answer >= 0 ? q.answer : 0), 0)
	return Math.round((total / (mentalHealthQuestions.value.length * 3)) * 100)
}

// ç”Ÿæˆå¥åº·å»ºè®®
const generateSuggestion = () => {
	const bmi = Number(calculateBMI())
	const lifestyleScore = calculateLifestyleScore()
	const mentalHealthScore = calculateMentalHealthScore()
	
	let suggestions = []
	
	// BMIç›¸å…³å»ºè®®
	if (bmi < 18.5) {
		suggestions.push('æ‚¨çš„ä½“é‡åè½»ï¼Œå»ºè®®ï¼š\n1. é€‚å½“å¢åŠ ä¼˜è´¨è›‹ç™½çš„æ‘„å…¥ï¼Œå¦‚ç˜¦è‚‰ã€é±¼ç±»ã€è›‹ç±»\n2. æ³¨æ„è¥å…»å‡è¡¡ï¼Œå¤šåƒæ–°é²œè”¬èœæ°´æœ\n3. è¿›è¡ŒåŠ›é‡è®­ç»ƒï¼Œå¢åŠ è‚Œè‚‰é‡\n4. ä¿æŒè§„å¾‹ä½œæ¯ï¼Œç¡®ä¿å……è¶³ç¡çœ ')
	} else if (bmi > 24) {
		suggestions.push('æ‚¨çš„ä½“é‡åé‡ï¼Œå»ºè®®ï¼š\n1. æ§åˆ¶æ¯æ—¥çƒ­é‡æ‘„å…¥ï¼Œå»ºè®®å‡å°‘300-500å¡è·¯é‡Œ\n2. å¢åŠ è¿åŠ¨é‡ï¼Œæ¯å‘¨è¿›è¡Œ3-5æ¬¡æœ‰æ°§è¿åŠ¨\n3. é¿å…é«˜ç³–ã€é«˜è„‚é£Ÿç‰©ï¼Œé€‰æ‹©ä½çƒ­é‡ã€é«˜çº¤ç»´çš„é£Ÿç‰©\n4. ä¿æŒè§„å¾‹ä½œæ¯ï¼Œé¿å…ç†¬å¤œ')
	}
	
	// ç”Ÿæ´»ä¹ æƒ¯å»ºè®®
	if (lifestyleScore < 60) {
		suggestions.push('æ‚¨çš„ç”Ÿæ´»ä¹ æƒ¯éœ€è¦æ”¹å–„ï¼Œå»ºè®®ï¼š\n1. ä¿æŒè§„å¾‹ä½œæ¯ï¼Œæ¯å¤©ä¿è¯7-8å°æ—¶ç¡çœ \n2. æ¯å‘¨è¿›è¡Œ3-4æ¬¡ä¸­ç­‰å¼ºåº¦è¿åŠ¨ï¼Œæ¯æ¬¡30-60åˆ†é’Ÿ\n3. ä¿æŒå‡è¡¡é¥®é£Ÿï¼Œæ¯å¤©æ‘„å…¥å……è¶³çš„æ°´åˆ†\n4. é¿å…ä¹…åï¼Œæ¯éš”1å°æ—¶èµ·èº«æ´»åŠ¨5-10åˆ†é’Ÿ\n5. æˆ’çƒŸé™é…’ï¼Œä¿æŒå¥åº·çš„ç”Ÿæ´»æ–¹å¼')
	} else if (lifestyleScore >= 80) {
		suggestions.push('æ‚¨çš„ç”Ÿæ´»ä¹ æƒ¯è‰¯å¥½ï¼Œå»ºè®®ï¼š\n1. ç»§ç»­ä¿æŒå½“å‰çš„ä½œæ¯è§„å¾‹\n2. å¯ä»¥å°è¯•å¢åŠ ä¸€äº›æ–°çš„è¿åŠ¨é¡¹ç›®ï¼Œä¿æŒè¿åŠ¨å…´è¶£\n3. å®šæœŸè¿›è¡Œå¥åº·ä½“æ£€ï¼Œé¢„é˜²ç–¾ç—…\n4. ä¸å®¶äººæœ‹å‹åˆ†äº«å¥åº·ç»éªŒï¼Œå¸¦åŠ¨ä»–äºº')
	}
	
	// å¿ƒç†å¥åº·å»ºè®®
	if (mentalHealthScore < 60) {
		suggestions.push('æ‚¨çš„å¿ƒç†çŠ¶æ€éœ€è¦å…³æ³¨ï¼Œå»ºè®®ï¼š\n1. æ¯å¤©è¿›è¡Œ15-20åˆ†é’Ÿçš„å†¥æƒ³æˆ–æ·±å‘¼å¸ç»ƒä¹ \n2. ä¿æŒç¤¾äº¤æ´»åŠ¨ï¼Œä¸å®¶äººæœ‹å‹å¤šäº¤æµ\n3. åŸ¹å…»å…´è¶£çˆ±å¥½ï¼Œè½¬ç§»æ³¨æ„åŠ›\n4. é€‚å½“è¿åŠ¨ï¼Œé‡Šæ”¾å‹åŠ›\n5. å¦‚æœå‹åŠ›æŒç»­ï¼Œå»ºè®®å¯»æ±‚ä¸“ä¸šå¿ƒç†å’¨è¯¢')
	} else if (mentalHealthScore >= 80) {
		suggestions.push('æ‚¨çš„å¿ƒç†çŠ¶æ€è‰¯å¥½ï¼Œå»ºè®®ï¼š\n1. ç»§ç»­ä¿æŒç§¯æä¹è§‚çš„å¿ƒæ€\n2. å¯ä»¥å°è¯•å¸®åŠ©ä»–äººï¼Œä¼ é€’æ­£èƒ½é‡\n3. å®šæœŸè¿›è¡Œè‡ªæˆ‘åæ€å’Œæ€»ç»“\n4. ä¿æŒå·¥ä½œä¸ç”Ÿæ´»çš„å¹³è¡¡')
	}
	
	// ç»¼åˆå»ºè®®
	if (suggestions.length === 0) {
		suggestions.push('æ‚¨çš„å¥åº·çŠ¶å†µè‰¯å¥½ï¼Œå»ºè®®ï¼š\n1. ç»§ç»­ä¿æŒå½“å‰çš„ç”Ÿæ´»æ–¹å¼\n2. å®šæœŸè¿›è¡Œå¥åº·æ£€æŸ¥\n3. ä¿æŒè¿åŠ¨ä¹ æƒ¯ï¼Œå¢å¼ºä½“è´¨\n4. å…³æ³¨è¥å…»å‡è¡¡ï¼Œé¢„é˜²ç–¾ç—…\n5. ä¿æŒç§¯æä¹è§‚çš„å¿ƒæ€')
	}
	
	// æ·»åŠ é€šç”¨å»ºè®®
	suggestions.push('\næ¸©é¦¨æç¤ºï¼š\n1. å»ºè®®æ¯å¹´è¿›è¡Œä¸€æ¬¡å…¨é¢ä½“æ£€\n2. ä¿æŒè§„å¾‹çš„ä½œæ¯æ—¶é—´\n3. æ³¨æ„é¥®é£Ÿå«ç”Ÿï¼Œé¿å…æš´é¥®æš´é£Ÿ\n4. ä¿æŒé€‚åº¦è¿åŠ¨ï¼Œé¿å…è¿‡åº¦è¿åŠ¨\n5. å¦‚æœ‰ä¸é€‚åŠæ—¶å°±åŒ»')
	
	return suggestions.join('\n\n')
}

// æäº¤è¯„ä¼°
const submitTest = () => {
	uni.showLoading({
		title: 'æäº¤ä¸­...'
	})
	
	setTimeout(() => {
		uni.hideLoading()
		uni.showToast({
			title: 'è¯„ä¼°å®Œæˆ',
			icon: 'success',
			duration: 2000
		})
		
		// å»¶è¿Ÿ2ç§’åé‡ç½®æ•°æ®
		setTimeout(() => {
			resetAllData()
		}, 2000)
	}, 1500)
}
</script>

<style>
.container {
	min-height: 100vh;
	background-color: #F5F9FF;
	display: flex;
	flex-direction: column;
}

.progress-bar {
	height: 8rpx;
	background-color: #E8F0FE;
	position: relative;
	margin-bottom: 20rpx;
}

.progress {
	height: 100%;
	background: linear-gradient(90deg, #4A90E2, #6BA4E5);
	transition: width 0.3s ease;
	border-radius: 4rpx;
}

.progress-text {
	position: absolute;
	right: 30rpx;
	top: -30rpx;
	font-size: 24rpx;
	color: #666;
}

.question-container {
	flex: 1;
	padding: 30rpx;
}

.question-section {
	background-color: #fff;
	border-radius: 24rpx;
	padding: 40rpx;
	margin-bottom: 30rpx;
	box-shadow: 0 8rpx 24rpx rgba(74, 144, 226, 0.08);
}

.section-title {
	font-size: 36rpx;
	font-weight: bold;
	color: #333;
	margin-bottom: 40rpx;
	display: flex;
	align-items: center;
}

.title-icon {
	margin-right: 16rpx;
	font-size: 40rpx;
}

.form-item {
	margin-bottom: 40rpx;
}

.label {
	font-size: 30rpx;
	color: #333;
	margin-bottom: 16rpx;
	display: block;
	font-weight: 500;
}

.input {
	width: 100%;
	height: 88rpx;
	background-color: #F8FAFF;
	border-radius: 16rpx;
	padding: 0 24rpx;
	font-size: 30rpx;
	border: 2rpx solid #E8F0FE;
}

.radio-group {
	display: flex;
	flex-wrap: wrap;
	gap: 24rpx;
}

.radio-label {
	display: flex;
	align-items: center;
	font-size: 30rpx;
	color: #333;
	padding: 16rpx 32rpx;
	background-color: #F8FAFF;
	border-radius: 12rpx;
	border: 2rpx solid #E8F0FE;
}

.question-item {
	margin-bottom: 50rpx;
}

.question-text {
	font-size: 30rpx;
	color: #333;
	margin-bottom: 24rpx;
	display: block;
	font-weight: 500;
}

.result-card {
	background-color: #F8FAFF;
	border-radius: 20rpx;
	padding: 40rpx;
}

.result-item {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 30rpx;
	padding: 20rpx;
	background-color: #fff;
	border-radius: 16rpx;
	box-shadow: 0 4rpx 12rpx rgba(74, 144, 226, 0.06);
}

.result-label {
	font-size: 30rpx;
	color: #333;
}

.result-value {
	font-size: 36rpx;
	color: #4A90E2;
	font-weight: bold;
}

.suggestion-box {
	margin-top: 40rpx;
	padding-top: 30rpx;
	border-top: 2rpx solid #E8F0FE;
}

.suggestion-title {
	font-size: 32rpx;
	color: #333;
	font-weight: bold;
	margin-bottom: 16rpx;
	display: block;
}

.suggestion-text {
	font-size: 28rpx;
	color: #666;
	line-height: 1.8;
}

.bottom-buttons {
	padding: 30rpx;
	display: flex;
	gap: 24rpx;
	background-color: #fff;
	box-shadow: 0 -4rpx 16rpx rgba(0, 0, 0, 0.06);
}

.btn {
	flex: 1;
	height: 88rpx;
	border-radius: 44rpx;
	font-size: 32rpx;
	display: flex;
	align-items: center;
	justify-content: center;
	font-weight: 500;
	transition: all 0.3s ease;
}

.prev-btn {
	background-color: #F8FAFF;
	color: #666;
}

.prev-btn:active {
	background-color: #E8F0FE;
}

.next-btn, .submit-btn {
	background: linear-gradient(90deg, #4A90E2, #6BA4E5);
	color: #fff;
}

.next-btn:active, .submit-btn:active {
	transform: scale(0.98);
	opacity: 0.9;
}
</style> 