!function(){"use strict";const e=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,t={handmade:["#ff0200","#ff0400","#ff0700","#ff0900","#ff0b00","#ff0e00","#ff1000","#ff1201","#ff1501","#ff1701","#ff1901","#ff1c01","#ff1e01","#ff2001","#ff2301","#ff2502","#ff2702","#ff2a02","#ff2c02","#ff2e02","#ff3002","#ff3302","#ff3502","#ff3803","#ff3a03","#ff3c03","#ff3e03","#ff4103","#ff4303","#ff4503","#ff4803","#ff4a04","#ff4c03","#ff4f03","#ff5103","#ff5303","#ff5503","#ff5803","#ff5a03","#ff5c03","#ff5e03","#ff6103","#ff6302","#ff6502","#ff6702","#ff6a02","#ff6c02","#ff6e02","#ff7002","#ff7302","#ff7502","#ff7702","#ff7901","#ff7c01","#ff7e01","#ff8001","#ff8201","#ff8501","#ff8701","#ff8901","#ff8b01","#ff8e01","#ff9001","#ff9201","#ff9501","#ff9701","#ff9901","#ff9c01","#ff9e01","#ffa001","#ffa301","#ffa501","#ffa701","#ffaa01","#ffac01","#ffae01","#ffb001","#ffb301","#ffb501","#ffb701","#ffba01","#ffbc01","#ffbe01","#ffc101","#ffc301","#ffc501","#ffc801","#ffca01","#ffcc01","#ffcf01","#ffd101","#ffd302","#fed501","#fdd702","#fcd801","#fcd901","#fbdb01","#fadc01","#f9dd01","#f8df01","#f7e001","#f7e201","#f6e301","#f5e401","#f4e601","#f3e701","#f2e801","#f1ea01","#f1eb01","#f0ed01","#efee01","#eeef01","#edf101","#ecf201","#ebf301","#ebf501","#eaf601","#e9f801","#e8f901","#e7fa01","#e6fc01","#e6fd01","#e5fe01","#e3ff07","#e1ff0f","#e0ff17","#deff1f","#dcff26","#daff2e","#d9ff36","#d7ff3e","#d5ff46","#d3ff4d","#d2ff55","#d0ff5d","#ceff65","#cdff6d","#cbff75","#c9ff7c","#c7ff84","#c6ff8c","#c4ff94","#c2ff9c","#c0ffa3","#bfffab","#bdffb3","#bbffbb","#baffc3","#b8ffca","#b6ffd2","#b4ffda","#b3ffe2","#b1ffea","#b0fef0","#b1fdf0","#b2fdf0","#b3fcf1","#b4fbf1","#b5faf2","#b6f9f2","#b7f8f2","#b8f7f3","#b9f6f3","#baf5f4","#bbf4f4","#bcf3f4","#bdf2f5","#bef2f5","#bff1f5","#c0f0f6","#c1eff6","#c2eef7","#c3edf7","#c4ecf8","#c5ebf8","#c6eaf8","#c7e9f9","#c8e8f9","#c9e7f9","#cae7fa","#cbe6fa","#cce5fb","#cde4fb","#cee3fb","#cfe2fc","#d0e1fc","#d1e0fd","#d3dffd","#d3defd","#d5ddfe","#d6dcfe","#d7dcff","#d7dcff","#d8ddff","#d8ddff","#d9deff","#dadeff","#dadfff","#dbdfff","#dce0ff","#dce0ff","#dde1ff","#dde2ff","#dee2ff","#dfe3ff","#dfe3ff","#e0e4ff","#e1e4ff","#e1e5ff","#e2e5ff","#e2e6ff","#e3e7ff","#e4e7ff","#e4e8ff","#e5e8ff","#e6e9ff","#e6e9ff","#e7eaff","#e7eaff","#e8ebff","#e9ebff","#e9ecff","#eaedff","#ebedff","#ebeeff","#eceeff","#ecefff","#edefff","#eef0ff","#eef0ff","#eff1ff","#f0f2ff","#f0f2ff","#f1f3ff","#f2f3ff","#f2f4ff","#f3f4ff","#f3f5ff","#f4f5ff","#f5f6ff","#f5f6ff","#f6f7ff","#f7f8ff","#f7f8ff","#f8f9ff","#f8f9ff","#f9faff","#fafaff","#fafbff","#fbfbff","#fcfcff","#fcfdff","#fdfdff","#fdfeff","#fefeff"].reverse().map((function(t){return t.replace(e,((e,t,f,i)=>"#"+t+t+f+f+i+i)).substring(1).match(/.{2}/g).map((e=>parseInt(e,16)))}))};function f(e,f=t.handmade){const i=Math.round(e*f.length);return f[i===f.length?f.length-1:i]}function i(e,t,f=t.getBoundingClientRect()){return f.height>.75*e.innerHeight||f.width*f.height>e.innerWidth*e.innerHeight*.5}var n;!function(e){e[e.Init=1]="Init",e[e.HeatmapBuilt=2]="HeatmapBuilt",e[e.Routing=3]="Routing"}(n||(n={}));class o{constructor(e,f){this.startBuildCB=e,this.endBuildCb=f,this.clicks=[],this.config={DIMENSION_SLOTS:100,TOUCH_RADIUS:15,ELEM_HM_EXTEND_RADIUS:true,RATIO_CUBOID_CONE_H:.7,HC_STEP:3,HC_TOP_K:25,OPACITY_BASE:100,POLICY_EXCLUDE_BG_ELEM:true,COLOR_SCHEME:t.handmade},this._rebuild=()=>{},this.sleeping=!1,this.canvas=document.createElement("canvas")}reset(e=!1){this.clicks=[],this.canvas.parentElement&&!e&&this.canvas.parentElement.removeChild(this.canvas),this.targetIframe&&this.targetIframe.contentDocument&&(this.targetDoc.removeEventListener("scroll",this._rebuild),this.targetDoc.removeEventListener("resize",this._rebuild))}feed(e){for(const t of e.clicks){const e=this.clicks.find((e=>e.selector===t.selector&&e.index===t.index));if(e)for(const f of t.clickUnionInfo){const t=e.clickUnionInfo.find((e=>e[0]===f[0]&&e[1]===f[1]));t?t[2]+=f[2]:e.clickUnionInfo.push(f)}else this.clicks.push(Object.assign(Object.assign({},t),{elemX:-1,elemY:-1,elemWidth:-1,elemHeight:-1,elemHMWidth:-1,elemHMHeight:-1,clickPointHMs:{}}))}}setTargetIframe(e){this.targetIframe=e;const t=()=>{console.log("heatmap begin rebuild"),this.build()};this._rebuild=t,e&&e.contentDocument&&this.targetDoc.addEventListener("scroll",t,!0),e&&e.contentWindow&&this.targetWin.addEventListener("resize",t,!0)}setHeatmapContainer(e){this.containerEl=e}sleep(){this.canvas.style.display="none",this.sleeping=!0}active(){this.canvas.style.display="initial",this.sleeping=!1}build(e=!1){var t,f,n;if(this.sleeping)return[];try{null===(t=null==this?void 0:this.startBuildCB)||void 0===t||t.call(this);const{HC_TOP_K:n,HC_STEP:o,TOUCH_RADIUS:l,ELEM_HM_EXTEND_RADIUS:c,POLICY_EXCLUDE_BG_ELEM:a}=this.config;this.positionCanvas();for(const t of this.clicks){if(t.excluded||!t.selector)continue;const f=this.getElement(t.selector,t.index);if(f){const n=f.getBoundingClientRect();if(a&&i(this.targetWin,f,n)){t.excluded=!0;continue}t.elemX=Math.round(n.x),t.elemY=Math.round(n.y);const o=this.visible(f),s=o?Math.round(n.width):0,r=o?Math.round(n.height):0;if(!e&&(t.elemWidth===s||t.elemHeight===r))continue;t.elemWidth=s,t.elemHeight=r,0===t.elemWidth||0===t.elemHeight?t.elemHM=void 0:(c?(t.elemHMWidth=t.elemWidth+2*l,t.elemHMHeight=t.elemHeight+2*l):(t.elemHMWidth=t.elemWidth,t.elemHMHeight=t.elemHeight),this.recomputeElemHeatmap(t))}else t.nonexistent=!0}this.clicks.sort(((e,t)=>e.totalClickCount?t.totalClickCount?t.totalClickCount-e.totalClickCount:-1:1));for(let t=0;t<n;t++){if(!this.clicks[t]||!this.clicks[t].elemHM)continue;const{elemHM:f,elemHMWeighted:i,elemHMValueMax:n,elemHMValueMin:l}=this.clicks[t];if(i&&!e)continue;const c=1,a=n-l,s=100-o*t-c;this.clicks[t].elemHMWeighted=f.map((e=>c+s*(e-l)/a))}if(this.clicks.length>n){let t=1,f=100;for(let e=n,i=this.clicks.length;e<i;e++)this.clicks[e].elemHM&&(this.clicks[e].elemHMValueMax>t?t=this.clicks[e].elemHMValueMax:this.clicks[e].elemHMValueMin<f&&(f=this.clicks[e].elemHMValueMin));const i=1,l=100-n*o-i;for(let t=n,f=this.clicks.length;t<f;t++){if(!this.clicks[t].elemHM)continue;if(this.clicks[t].elemHMWeighted&&!e)continue;const{elemHM:f,elemHMValueMax:n,elemHMValueMin:o}=this.clicks[t],c=n-o;this.clicks[t].elemHMWeighted=f.map((e=>i+l*(e-o)/c))}}const s=new Array(this.canvas.width*this.canvas.height);s.fill(0);for(let e=this.clicks.length-1;e>=0;e--){const t=this.clicks[e];if(!t.elemHM)continue;const{elemHM:f,elemHMWeighted:i,elemX:n,elemY:o,elemWidth:a,elemHeight:r,elemHMWidth:d,elemHMHeight:h}=t;for(let e=0;e<d;e++)for(let t=0;t<h;t++){const f=e+n-(c?l:0),a=t+o-(c?l:0);f<0||a<0||f>=this.canvas.width||a>=this.canvas.height||(s[a*this.canvas.width+f]=Math.max(s[a*this.canvas.width+f],i[t*d+e]))}}return this.drawHeatmap(s),null===(f=null==this?void 0:this.endBuildCb)||void 0===f||f.call(this),this.clicks}catch(e){return null===(n=null==this?void 0:this.endBuildCb)||void 0===n||n.call(this),console.error("heatmap build error",e),[]}}getElement(e,t){var f,i;try{let n=this.targetDoc;const o=e.split(" ");if(o.length>1){e=o.pop();for(const e of o){const[t,o]=e.split(":");n=null!==(i=null===(f=null==n?void 0:n.querySelectorAll(t)[Number(o)])||void 0===f?void 0:f.shadowRoot)&&void 0!==i?i:n}}const l=null==n?void 0:n.querySelectorAll(e)[t];return null!=l?l:null}catch(e){return console.error("[replayer] getElement err:",e),null}}recomputeElemHeatmap(e){const{DIMENSION_SLOTS:t,TOUCH_RADIUS:f,ELEM_HM_EXTEND_RADIUS:i}=this.config,n=e.elemWidth/t,o=e.elemHeight/t,l=Math.floor(e.elemWidth/t/2),c=Math.floor(e.elemHeight/t/2),a=new Array(e.elemHMWidth*e.elemHMHeight);a.fill(0);let s=0,r=-1/0,d=1/0;for(const[h,u,m]of e.clickUnionInfo){const g=Math.round(e.elemWidth/t*h+l)+(i?f:0),p=Math.round(e.elemHeight/t*u+c)+(i?f:0);s+=m;const v=f,_=3*(n*o*m)/(Math.PI*v*v)/v,b=g-v,H=p-v,y=new Array(2*v*v*2);y.fill(0);for(let t=0;t<=2*v;t++)for(let f=0;f<=2*v;f++){const i=b+t,n=H+f;if(i<0||n<0||i>=e.elemHMWidth||n>=e.elemHMHeight)continue;const o=Math.abs(g-i),l=Math.abs(p-n),c=Math.sqrt(o*o+l*l);if(c<v){const o=_*(v-c);y[f*v*2+t]=o;const l=n*e.elemHMWidth+i;a[l]+=o;const s=a[l];0!==s&&(s>r&&(r=s),s<d&&(d=s))}}e.clickPointHMs[`${h},${u}`]=y}e.totalClickCount=s,r!==-1/0&&(e.elemHMValueMax=r,e.elemHMValueMin=d,e.elemHM=a)}positionCanvas(){if(!this.targetIframe)return;const e=this.targetIframe.getBoundingClientRect();this.canvas.width=e.width,this.canvas.height=e.height,this.canvas.style.cssText=`position: absolute;  pointer-events: none;left: ${e.left}px;top:${e.top}px;z-index: 2147483646;`,this.canvas.id="donut___heatmap-canvas",this.canvas.parentElement!==this.containerEl&&this.containerEl.appendChild(this.canvas)}drawHeatmap(e,t=0,i=0,n=this.canvas.width,o=this.canvas.height,l=!1){if(console.time("perf:drawHeatmap"),!n||!o)return;const{OPACITY_BASE:c}=this.config,a=255-c;let s=1/0,r=-1/0;for(const t of e)t>r&&(r=t),t>0&&t<s&&(s=t);s===1/0&&(s=0);const d=new Uint8ClampedArray(n*o*4);for(let t=0,i=e.length;t<i;t++){const i=e[t];if(0===i)d[4*t]=255,d[4*t+1]=255,d[4*t+2]=255,d[4*t+3]=0;else{const e=(i-s)/(r-s),[n,o,h]=f(e,this.config.COLOR_SCHEME);d[4*t]=n,d[4*t+1]=o,d[4*t+2]=h,d[4*t+3]=l?128:e>.2?c+a*e:255*e}}const h=new ImageData(d,n,o);this.canvas.getContext("2d").putImageData(h,t,i),console.timeEnd("perf:drawHeatmap")}visible(e){let t=this.targetDoc;const f=e.getBoundingClientRect();let i=!1;if(!1===i&&f.width>0&&f.height>0)for(;!i&&t;){let n=null,o=t.elementsFromPoint(f.left+f.width/2,f.top+f.height/2);for(let f of o)if("canvas"!==f.tagName){i=f===e,n=f.shadowRoot&&f.shadowRoot!=t?f.shadowRoot:null;break}t=n}return i}get targetWin(){return this.targetIframe.contentWindow}get targetDoc(){return this.targetIframe.contentDocument}}function l(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var c="object"==typeof global&&global&&global.Object===Object&&global,a="object"==typeof self&&self&&self.Object===Object&&self,s=c||a||Function("return this")(),r=function(){return s.Date.now()},d=/\s/;var h=/^\s+/;function u(e){return e?e.slice(0,function(e){for(var t=e.length;t--&&d.test(e.charAt(t)););return t}(e)+1).replace(h,""):e}var m=s.Symbol,g=Object.prototype,p=g.hasOwnProperty,v=g.toString,_=m?m.toStringTag:void 0;var b=Object.prototype.toString;var H=m?m.toStringTag:void 0;function y(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":H&&H in Object(e)?function(e){var t=p.call(e,_),f=e[_];try{e[_]=void 0;var i=!0}catch(e){}var n=v.call(e);return i&&(t?e[_]=f:delete e[_]),n}(e):function(e){return b.call(e)}(e)}var M=/^[-+]0x[0-9a-f]+$/i,w=/^0b[01]+$/i,E=/^0o[0-7]+$/i,C=parseInt;function k(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return null!=e&&"object"==typeof e}(e)&&"[object Symbol]"==y(e)}(e))return NaN;if(l(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=l(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=u(e);var f=w.test(e);return f||E.test(e)?C(e.slice(2),f?2:8):M.test(e)?NaN:+e}var I=Math.max,x=Math.min;function T(e,t,f){var i,n,o,c,a,s,d=0,h=!1,u=!1,m=!0;if("function"!=typeof e)throw new TypeError("Expected a function");function g(t){var f=i,o=n;return i=n=void 0,d=t,c=e.apply(o,f)}function p(e){return d=e,a=setTimeout(_,t),h?g(e):c}function v(e){var f=e-s;return void 0===s||f>=t||f<0||u&&e-d>=o}function _(){var e=r();if(v(e))return b(e);a=setTimeout(_,function(e){var f=t-(e-s);return u?x(f,o-(e-d)):f}(e))}function b(e){return a=void 0,m&&i?g(e):(i=n=void 0,c)}function H(){var e=r(),f=v(e);if(i=arguments,n=this,s=e,f){if(void 0===a)return p(s);if(u)return clearTimeout(a),a=setTimeout(_,t),g(s)}return void 0===a&&(a=setTimeout(_,t)),c}return t=k(t)||0,l(f)&&(h=!!f.leading,o=(u="maxWait"in f)?I(k(f.maxWait)||0,t):o,m="trailing"in f?!!f.trailing:m),H.cancel=function(){void 0!==a&&clearTimeout(a),d=0,i=s=n=a=void 0},H.flush=function(){return void 0===a?c:b(r())},H}const O="https://dev.weixin.qq.com";function S(e){var t;const f=null!==(t=e.data)&&void 0!==t?t:{};if(e.origin===O)switch(f.action){case"controller-init":W({type:n.Init,data:{url:location.href,path:"",query:""}}),sessionStorage.setItem("__donut_controller_env__","1"),console.log("__donut_controller_env__"),L();break;case"heatmap-init":console.log({data:null==f?void 0:f.data}),function(e){var t,f;if(!e)return;const i=new o,l=window;l.__past_hm__&&(null===(f=null===(t=null==l?void 0:l.__past_hm__)||void 0===t?void 0:t.reset)||void 0===f||f.call(t));l.__past_hm__=i,i.feed(e),i.setTargetIframe({contentWindow:window,contentDocument:document,getBoundingClientRect:()=>({left:document.documentElement.scrollLeft||document.body.scrollLeft,top:document.documentElement.scrollTop||document.body.scrollTop,width:window.innerWidth,height:window.innerHeight})}),i.setHeatmapContainer(document.body);const c=i.build(!0);W({type:n.HeatmapBuilt,data:{processedData:c}})}(null==f?void 0:f.data);break;case"highlight-ele":const e=f.data;!function(e,t){const f=window,i=document;if(!f||!i)return void console.error("runtime missing when call highlightEl");if(i.querySelectorAll(".__color__highlight").forEach((e=>{i.body.removeChild(e)})),!e)return void console.error("selector missing when call highlightEl");const n=Array.from(i.querySelectorAll(e))[t];if(!n)return void console.error("cor ele missing when call highlightEl",{selector:e,index:t});const{width:o,height:c,left:a,top:s}=n.getBoundingClientRect(),r=i.createElement("div");r.className="__color__highlight __selected_follow",r.style.setProperty("position","fixed"),r.style.setProperty("width",`${o}px`),r.style.setProperty("height",`${c}px`),r.style.setProperty("left",`${a}px`),r.style.setProperty("top",`${s}px`),r.style.setProperty("z-index","2147483647"),r.style.setProperty("background-color","rgba(250, 157, 59, 0.4)"),r.style.setProperty("pointer-events","none"),r.style.setProperty("transition","all 0.008s ease-in-out"),i.body.appendChild(r),f.__ev_mask_scroll_listener&&i.removeEventListener("scroll",f.__ev_mask_scroll_listener,!0),f.__ev_mask_scroll_listener=function(e,t,f){var i=!0,n=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return l(f)&&(i="leading"in f?!!f.leading:i,n="trailing"in f?!!f.trailing:n),T(e,t,{leading:i,maxWait:t,trailing:n})}((()=>{if(n&&r){const{width:e,height:t,left:f,top:i}=n.getBoundingClientRect();r.style.setProperty("width",`${e}px`),r.style.setProperty("height",`${t}px`),r.style.setProperty("left",`${f}px`),r.style.setProperty("top",`${i}px`)}}),8),i.addEventListener("scroll",f.__ev_mask_scroll_listener,!0),console.log({ele:n}),n.scrollIntoView(!1)}(e.selector,e.index);break;case"navigate-to":const t=f.data;location.href=t.url}}function W(e){var t,f;null===(f=(t=window.parent).postMessage)||void 0===f||f.call(t,e,O)}function D(){const[e,t]=function(){let e=location.search;return"?"===e[0]&&(e=e.replace("?","")),[location.href?location.href.replace(location.hash,"").replace(location.search,""):location.href,e]}();W({type:n.Routing,data:{path:e,query:t,url:location.href}})}const L=()=>{if(D(),window.__DONUT_ROUTE_LISTEN_INITED__)return;window.__DONUT_ROUTE_LISTEN_INITED__=1,window.addEventListener("load",D),window.addEventListener("pageshow",(()=>{console.log("pageshow"),D()})),window.addEventListener("popstate",D),window.addEventListener("beforeunload",D);const e=history.pushState;history.pushState=function(...t){e.apply(this,t),D()};const t=history.replaceState;history.replaceState=function(...e){t.apply(this,e),D()}};window.__wxdonutuo_hm_install=()=>{window.addEventListener("message",S),sessionStorage.getItem("__donut_controller_env__")&&L()}}();
